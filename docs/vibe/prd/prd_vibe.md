## 1. Product Summary

A Python package and CLI that converts PDFs into clean, hierarchy-preserved Markdown trees optimized for LLM ingestion. The system reliably detects document semantics (headings, sections, tables, figures) across heterogeneous PDFs, reconstructs the hierarchy even when a formal ToC is missing, and emits well-named, tree-structured Markdown files with optional YAML front matter for downstream tooling. Parsing is primarily delegated to Upstage’s DocumentParse API; the package provides orchestration, normalization, hierarchy reconstruction, and deterministic output formatting. Mono-repo, pure Python, designed to be lightweight, extensible, and pluggable for future agents.

## 2. Objectives / Success Metrics
- **Accuracy of hierarchy reconstruction**: ≥95% correct section ordering and nesting on a test suite of representative PDFs (lecture notes, textbooks, academic papers).
- **Cleanliness/readiness of output**: ≥90% of outputs require no manual cleanup to be directly used by LLM context ingestion pipelines.
- **Throughput**: Process ≥200 pages/minute per worker for text-only PDFs; ≥80 pages/minute for mixed content (text/tables/figures) using DocumentParse.
- **Determinism**: Given fixed inputs and config, produce byte-identical Markdown outputs.
- **CLI ergonomics**: Complete a bulk conversion job with a single command and a single YAML config file.

## 3. Target Users
- **Researchers/Academics** organizing literature; primary source types: lecture notes, textbooks, academic papers.
- **Digital Archivists** converting large PDF collections at scale.
- Secondary: **Technical writers**, **AI/ML engineers** preparing datasets.

## 4. Primary Use Cases
- **LLM dataset preparation**: Split technical PDFs into semantically chunked Markdown for retrieval/fine-tuning.
- **Knowledge-base ingestion**: Convert corporate/academic PDFs while preserving structure for downstream search and RAG systems.
- **Course and research organization**: Produce navigable Markdown trees from lecture notes and papers.

## 5. Core Features (MVP)
- **Automatic ToC extraction and hierarchy reconstruction** when present; fallback to robust heuristics when absent.
- **Fallback heuristic section detection**: font-size tiers, headings patterns, whitespace/layout cues, page anchors.
- **Bulk-processing CLI**: convert multiple PDFs using a single command and YAML config.
- **YAML configuration**: user-defined global and per-source options (e.g., source_type, language, output schema, page ranges). Some YAML generated by the package (derived metadata) to accompany outputs.
- **Upstage DocumentParse integration**: primary parser for text, tables, and figures; outputs normalized to internal schema.
- **Deterministic, tree-structured Markdown emission**: headings mapped to directory structure and file names; optional YAML front matter.

## 6. Additional Features (Post-MVP/Stretch)
- **Interactive structure preview**: visualize and edit detected hierarchy before export.
- **Pluggable parsing backends** beyond Upstage (e.g., pdfminer, PyMuPDF) via a standardized adapter interface.
- **Optional image extraction/embedding** in Markdown for figures with stable references in text.
- **LangChain integration shims** (e.g., LangGraph-friendly chunk boundaries and metadata fields).

## 7. Out of Scope
- Cloud storage integrations (S3/GCS), SaaS UI, and desktop GUI.
- Language auto-detection (language is provided in config).
- Enterprise security/compliance features (on-prem, encryption). Avoid unnecessary burdens.

## 8. Technical Overview
### Architecture
- **Layers**:
  - Ingest: file discovery, input validation.
  - Parse: Upstage DocumentParse API client; optional adapters later.
  - Normalize: convert parser output into internal document model (blocks, spans, tables, figures, references).
  - Structure: ToC alignment, heading detection, heuristic reconstruction, page-range mapping.
  - Emit: Markdown tree generator, YAML front matter writer, file naming and directory mapping.
  - Orchestrate: CLI workflows, job controller, logging, error handling, retries, and deterministic seeding.
- **Config**: single YAML controlling source_type, language, parser options, output schema, chunking thresholds, file naming template.

### Key Dependencies
- **langchain, langchain-core, langchain-upstage**: integration utilities and future graph workflows.
- **pymupdf** (optional, backup), **markitdown** for Markdown fidelity in edge cases.
- **pydantic / pydantic-settings** for config and strong data models.
- **dependency-injector** for pluggability.
- **tqdm, pandas, numpy** for progress/ops.

### Performance
- Parallel batch execution across files; concurrency bounded via config.
- Caching of parser responses for idempotent re-runs.
- Streaming writing to avoid memory spikes; page-range filtering to limit scope.

### Distribution
- Pure Python package in mono-repo; install via Poetry or pip.
- CLI entry point: `local-files-to-md` with subcommands `convert`, `validate`, `preview` (preview is post-MVP).

## 9. MVP Milestones & Timeline
- **M1 (Week 1-2): Foundations**: config schema (pydantic), CLI skeleton, file discovery, logging, basic Upstage client, golden-sample PDFs.
- **M2 (Week 3-4): Parsing & Normalization**: integrate DocumentParse, internal document model, deterministic normalization, unit tests.
- **M3 (Week 5-6): Structure & Emission**: ToC extraction + heuristics, Markdown emitter, YAML front matter, end-to-end CLI for bulk.
- **M4 (Week 7): Hardening**: performance passes, retries/caching, deterministic outputs, docs, example configs.

## 10. Risks & Mitigations
- **Parser variability or API changes**: Abstract via adapter interface; pin versions; add conformance tests.
- **Heuristic misclassification on unusual PDFs**: Maintain rule-sets per source_type; allow override patterns via config; add preview tool (post-MVP).
- **Throughput bottlenecks**: introduce caching, concurrency, and page-range filtering; stream writes.
- **File naming collisions and OS path issues**: deterministic slugify rules; length guards; collision detection.
- **Markdown fidelity (tables/figures)**: fallback rendering paths; embed images optionally; regression tests on fixtures.

## 11. Acceptance Criteria (For tests)
- Given a fixed YAML config and input set, outputs are byte-identical across runs.
- For a benchmark set of PDFs (lecture notes, textbook, paper):
  - ≥95% of headings and sections correctly ordered and nested.
  - Tables are preserved as Markdown tables or referenced assets with stable links.
  - Figures are preserved via references; optional embedded images when enabled.
- CLI can process a directory of ≥100 PDFs in one command with non-zero concurrency and produce a tree-structured output.
- Failures are logged with actionable messages, and partial runs are resumable via cached parser artifacts.
